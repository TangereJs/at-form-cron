<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-theme/at-theme.html">
<link rel="import" href="../jquery2-import/jquery2-import.html">
<link rel="import" href="../at-i18n/at-i18n-behavior.html">
<link rel="import" href="../at-form-behaviors/at-form-behaviors.html">
<link rel="import" href="styles/jqcron-styles.html">
<link rel="import" href="at-form-cron-input-validation-behavior.html">

<script src="scripts/jqCron.js" charset="utf-8"></script>

<dom-module id="at-form-cron">
  <template>
    <style include="at-form-common"></style>
    <style include="jqcron-styles"></style>
    <style>
      :host {
        @apply(--at-form-host);
      }

      :host * {
        box-sizing: border-box;
      }

      .at-content-container {
        padding: 6px 0 0 0;
      }
    </style>

    <div id="atContainer" class="at-container">
      <iron-label id="label" for="input">{{label}}</iron-label>
      <div id="contentContainer" class="at-content-container"></div>
      <div id="hint"></div>
    </div>
  </template>
  <script>
    'use strict';

    Polymer({
      is: 'at-form-cron',
      behaviors: [Tangere.behaviors.i18n, Tangere.behaviors.formUIGeneric, Tangere.behaviors.AtFormCronInputValidation ],
      properties: {
        /**
         * Element's label for element display purposes
         * @property label
         * @type String
         * @default ""
         */
        label: {
          type: String,
          value: '',
          title: 'Label'
        },

        /**
         * When true label is hidden
         * @property hideLabel
         * @type Boolean
         * @default false
         */
        hideLabel: {
          type: Boolean,
          value: false,
          observer: '_hideLabelChanged',
          title: 'Do not show the label'
        },

        /**
         * Element's disabled state
         * @property disabled
         * @type Boolean
         * @default false
         */
        disabled: {
          type: Boolean,
          value: false,
          observer: '_disabledChanged',
          title: 'Field value can not be changed'
        },

        /**
         * Hides the element. When hidden nothing is displayed for the element
         * @property hide
         * @type Boolean
         * @default false
         */
        hide: {
          type: Boolean,
          value: false,
          observer: '_hideChanged',
          title: 'Element is hidden'
        },

        /**
         * Element's required state for element validation purposes
         * @property required
         * @type Boolean
         * @default false
         */
        required: {
          type: Boolean,
          value: false,
          title: 'Input required'
        },

        /**
         * Elements value
         * @property value
         * @type String
         * @default ''
         */
        value: {
          type: String,
          value: '',
          observer: '_valueChanged',
          title: 'Value'
        }
      },

      observers: [
        '_internalValidStateUpdate(required)'
      ],

      $meta: [{
        title: 'Cron',
        type: 'string',
        xtype: 'cron'
      }],

      _hideLabelChanged: function(newValue, oldValue) {
        this.toggleClass('hidden', newValue, this.$.label);
      },

      _disabledChanged: function(newValue, oldValue) {
        this.toggleClass('disabled', newValue, this.$.atContainer);
        if (this._cronInstance) {
          var result = newValue ? this._cronInstance.disable() : this._cronInstance.enable();
        }
      },

      _hideChanged: function(newValue, oldValue) {
        this.toggleClass('hidden', newValue, this.$.atContainer);
      },

      ready: function() {
        var cronContainer = this.$.contentContainer;
        var $cronContainer = $(cronContainer);

        this._createCronInstance();

        var self = this;
        $cronContainer.on('cron:change', function(event, cronValue) {
          if (self._internalValueUpdate) return;
          self.debounce('cronchange', function() {
            self.validate();
          }, 100);
        });

        this._isReady = true;
        this._internalValidStateUpdate(this.required, true);
      },

      _internalValidStateUpdate: function(required, skip) {
        // when required changes the fastest way to add/remove 'none' is to recreate cron instance
        if (!skip) {
          this._createCronInstance();
        }

        if (this._isReady) {
          this.validate();
        }
      },

      _valueChanged: function(newValue, oldValue) {

        this._internalValueUpdate = true;
        if (this._isValidCronValue(newValue)) {
          if ([null, ""].indexOf(newValue) !== -1) {
            this._setCronValue("- - - - -");
          } else {
            this._setCronValue(newValue);
          }
        } else {
          this._setCronValue("- - - - -");
        }
        this._internalValueUpdate = false;

        if (this.autoValidate) {
          this._validate(true);
        }
        if (this._isReady) {
          this._fireValueChangedEvent(newValue);
        }
      },

      validate: function(showError) {
        if (showError === undefined) showError = this.autoValidate;

        var cronValue = this._getCronValue();
        if (([null].indexOf(this.value) !== -1 && ["* * * * *", "- - - - -"].indexOf(cronValue) === -1) || ([null].indexOf(this.value) === -1 && this.value !== cronValue)) {
          if (this._isValidCronValue(this.value)) {
            this.value = cronValue;
          }
        }

        return this._validate(showError);
      },

      _validate: function(showError) {
        var validationResult = this._validateBaseData();
        this._handleValidationResult(validationResult);
        if (!validationResult.isValid) {
          return validationResult.isValid;
        }

        validationResult = this._validateData(this, this.value, this.T.bind(this));
        if (showError) { this._handleValidationResult(validationResult); }

        return validationResult.isValid;
      },

      _updateUIValidState: function(isValid) {
        var label = this.$.label;
        this.toggleClass('error', !isValid, label);
        var contentContainer = this.$.contentContainer;
        this.toggleClass('error', !isValid, contentContainer);
      },

      focus: function() {},

      _getFocusableElement: function() {
        return this;
      },

      /********************************************************************************/
      /* Helper methods
      /********************************************************************************/

      _createCronInstance: function() {
        var cronContainer = this.$.contentContainer;
        Polymer.dom(cronContainer).innerHTML = "";
        var $cronContainer = $(cronContainer);

        var currentValue = this.value;
        var defaultValue;
        if (this._isValidCronValue(currentValue)) {
          if ([null, ""].indexOf(currentValue) !== -1) {
            defaultValue = "- - - - -";
          } else {
            defaultValue = currentValue;
          }
        } else {
          defaultValue = "- - - - -";
        }

        var cronOptions = {
          multiple_time_minutes: true,
          required: this.required,
          default_value: defaultValue,
          lang: this.getLocale()
        };

        this._cronInstance = $(cronContainer).jqCron(cronOptions, this).data('jqCron');
        this.scopeSubtree(cronContainer);
      },

      _getCronValue: function() {
        return this._cronInstance.getCron();
      },

      _setCronValue: function(newValue) {
        if (!this._cronInstance) {
          return;
        }
        var current = this._getCronValue();
        if (current !== newValue) {
          this._cronInstance.setCron(newValue);
        }
      },

      _isValidCronValue: function(value) {
        function isString(obj) {
          return Object.prototype.toString.call(obj) === "[object String]";
        }

        if ([null, ""].indexOf(value) !== -1) return true;

        if (!isString(value)) return false;

        var parts = value.split(" ");

        if (parts.length !== 5) return false;

        var isValid = true;

        for (var i = 0; i < parts.length && isValid; i++) {
          var part = parts[i];
          isValid = isValid && (["*", "-"].indexOf(part) !== -1 || !isNaN(parseInt(part)));
        }

        return isValid;
      }
    });
  </script>
</dom-module>
